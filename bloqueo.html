import { supabase } from './supabase.js';

document.addEventListener('DOMContentLoaded', async () => {
  const params = new URLSearchParams(window.location.search);
  const imei = params.get('imei');
  const token = params.get('token');

  if (!imei || !token) return;

  await registrarEvento(imei, 'bloqueo_mostrado');

  // Verificar si el estado cambi√≥
  const { data, error } = await supabase
    .from('dispositivos')
    .select('estado')
    .eq('imei', imei)
    .eq('token', token)
    .single();

  if (data && data.estado === 'activo') {
    window.location.href = cliente.html?imei=${imei}&token=${token};
  }
});

async function registrarEvento(imei, tipo) {
  await supabase.from('eventos').insert([
    {
      imei,
      tipo,
      timestamp: new Date().toISOString()
    }
  ]);
}